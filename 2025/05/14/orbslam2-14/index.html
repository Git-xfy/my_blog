<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>优化——Sim(3) 位姿优化 | 我的学习笔记</title><meta name="author" content="Xue"><meta name="copyright" content="Xue"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="闭环线程中的 Sim(3) 位姿优化 理解在检测到潜在的闭环时，系统如何优化当前关键帧 (KF1) 与闭环候选关键帧 (KF2) 之间的相对位姿。此相对位姿通过一个 Sim(3) 变换（包含旋转、平移和尺度信息）来描述。关键点在于，此优化过程仅针对 Sim(3) 位姿进行，地图点的三维坐标在此步骤中保持固定，不参与优化。  一、核心思想：图优化 (Graph Optimization) 该优化过">
<meta property="og:type" content="article">
<meta property="og:title" content="优化——Sim(3) 位姿优化">
<meta property="og:url" content="https://feiyblog.netlify.app/2025/05/14/orbslam2-14/index.html">
<meta property="og:site_name" content="我的学习笔记">
<meta property="og:description" content="闭环线程中的 Sim(3) 位姿优化 理解在检测到潜在的闭环时，系统如何优化当前关键帧 (KF1) 与闭环候选关键帧 (KF2) 之间的相对位姿。此相对位姿通过一个 Sim(3) 变换（包含旋转、平移和尺度信息）来描述。关键点在于，此优化过程仅针对 Sim(3) 位姿进行，地图点的三维坐标在此步骤中保持固定，不参与优化。  一、核心思想：图优化 (Graph Optimization) 该优化过">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://fyblog.oss-cn-shanghai.aliyuncs.com/blog/20250428231608640.png">
<meta property="article:published_time" content="2025-05-14T06:30:26.000Z">
<meta property="article:modified_time" content="2025-05-14T09:19:59.146Z">
<meta property="article:author" content="Xue">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fyblog.oss-cn-shanghai.aliyuncs.com/blog/20250428231608640.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "优化——Sim(3) 位姿优化",
  "url": "https://feiyblog.netlify.app/2025/05/14/orbslam2-14/",
  "image": "https://fyblog.oss-cn-shanghai.aliyuncs.com/blog/20250428231608640.png",
  "datePublished": "2025-05-14T06:30:26.000Z",
  "dateModified": "2025-05-14T09:19:59.146Z",
  "author": [
    {
      "@type": "Person",
      "name": "Xue",
      "url": "https://feiyblog.netlify.app/"
    }
  ]
}</script><link rel="shortcut icon" href="https://fyblog.oss-cn-shanghai.aliyuncs.com/blog/20250424131237614.png"><link rel="canonical" href="https://feiyblog.netlify.app/2025/05/14/orbslam2-14/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?568315545f51aa0aac415d8a71f8bd8f";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
btf.addGlobalFn('pjaxComplete', () => {
  _hmt.push(['_trackPageview',window.location.pathname])
}, 'baidu_analytics')
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '优化——Sim(3) 位姿优化',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background: linear-gradient(90deg,rgba(42, 123, 155, 1) 0%, rgba(171, 169, 169, 1) 100%, rgba(237, 221, 83, 1) 100%);;"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://fyblog.oss-cn-shanghai.aliyuncs.com/blog/20250423093410435.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">32</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://fyblog.oss-cn-shanghai.aliyuncs.com/blog/20250428231608640.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">我的学习笔记</span></a><a class="nav-page-title" href="/"><span class="site-name">优化——Sim(3) 位姿优化</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">优化——Sim(3) 位姿优化</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-05-14T06:30:26.000Z" title="发表于 2025-05-14 14:30:26">2025-05-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-05-14T09:19:59.146Z" title="更新于 2025-05-14 17:19:59">2025-05-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/SLAM/">SLAM</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="闭环线程中的-sim3-位姿优化"><a class="markdownIt-Anchor" href="#闭环线程中的-sim3-位姿优化"></a> 闭环线程中的 Sim(3) 位姿优化</h1>
<p>理解在检测到潜在的闭环时，系统如何优化当前关键帧 (KF1) 与闭环候选关键帧 (KF2) 之间的相对位姿。此相对位姿通过一个 Sim(3) 变换（包含旋转、平移和尺度信息）来描述。<strong>关键点在于，此优化过程仅针对 Sim(3) 位姿进行，地图点的三维坐标在此步骤中保持固定，不参与优化。</strong></p>
<h2 id="一-核心思想图优化-graph-optimization"><a class="markdownIt-Anchor" href="#一-核心思想图优化-graph-optimization"></a> 一、核心思想：图优化 (Graph Optimization)</h2>
<p>该优化过程依赖于图优化方法，具体实现通常借助 g2o (General Graph Optimization) 框架。图优化的基本组成元素如下：</p>
<ul>
<li><strong>顶点 (Vertices)：</strong> 图中的节点，代表了系统中待优化的变量。在我们的场景中，主要是 Sim(3) 位姿。</li>
<li><strong>边 (Edges)：</strong> 连接顶点的边，代表了这些变量之间存在的约束关系。这些约束通常以误差函数的形式表达，优化的目标是最小化所有误差的总和。</li>
</ul>
<h2 id="二-顶点的选择-vertices"><a class="markdownIt-Anchor" href="#二-顶点的选择-vertices"></a> 二、顶点的选择 (Vertices)</h2>
<p>在闭环的 Sim(3) 位姿优化问题中，主要涉及以下两种类型的顶点：</p>
<ol>
<li><strong>待优化的 Sim(3) 位姿:</strong>
<ul>
<li><strong>描述：</strong> 这是我们核心的优化目标，代表了从闭环候选关键帧 KF2 到当前关键帧 KF1 的 7 自由度相似变换 (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>i</mi><mi>m</mi><mo stretchy="false">(</mo><mn>3</mn><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>R</mi><mo separator="true">,</mo><mi>t</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Sim(3) = (s, R, t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">i</span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord">3</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">t</span><span class="mclose">)</span></span></span></span>)，其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">s</span></span></span></span> 为尺度因子， <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span> 为旋转矩阵， <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span> 为平移向量。</li>
<li><strong>g2o 类型：</strong> 在 g2o 中，这类顶点通常表示为 <code>g2o::VertexSim3Expmap</code>。它使用李代数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>i</mi><mi>m</mi><mo stretchy="false">(</mo><mn>3</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">sim(3)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord">3</span><span class="mclose">)</span></span></span></span> 进行参数化。</li>
<li><strong>图示 (参考图 14-3)：</strong> 例如 <code>g2oS12</code>，在优化器中可能对应 <code>optimizer.vertex(0)</code>。</li>
</ul>
</li>
<li><strong>匹配的地图点 (MapPoints):</strong>
<ul>
<li><strong>描述：</strong> 这些是在 KF1 和 KF2 中共同观测到的三维地图点。在 Sim(3) 位姿优化阶段，这些地图点的三维坐标被认为是准确的，<strong>因此它们是固定的 (fixed)，不参与优化</strong>。它们作为稳定的参考点，为优化 Sim(3) 位姿提供约束。</li>
<li><strong>g2o 类型：</strong> 在 g2o 中，三维点通常表示为 <code>g2o::VertexSBAPointXYZ</code> (SBA: Sparse Bundle Adjustment)。</li>
<li><strong>图示 (参考图 14-3)：</strong> 例如点 <code>P3D2c</code>，在优化器中可能对应 <code>optimizer.vertex(id2)</code>，其中 <code>id2</code> 是该地图点在优化器中的唯一标识。</li>
</ul>
</li>
</ol>
<h2 id="三-边的选择-edges"><a class="markdownIt-Anchor" href="#三-边的选择-edges"></a> 三、边的选择 (Edges)</h2>
<p>边定义了顶点之间的约束，即地图点在 Sim(3) 变换下的投影关系。这些是二元边，因为它连接了两种类型的顶点：一个地图点顶点和一个 Sim(3) 位姿顶点。主要存在两种类型的边，对应于投影的方向：</p>
<ol>
<li><strong>正向投影边 (Forward Projection Edge):</strong>
<ul>
<li><strong>描述：</strong> 将<strong>闭环候选关键帧 KF2</strong> 中的一个地图点（在其自身的相机坐标系下），通过待优化的 Sim(3) 位姿 (<code>g2oS12</code>)，变换到<strong>当前关键帧 KF1</strong> 的相机坐标系下，并进一步投影到 KF1 的图像平面上。其误差是该投影点与 KF1 中对应特征点的实际观测位置之间的差异。</li>
<li><strong>g2o 类型：</strong> <code>g2o::EdgeSim3ProjectXYZ</code>。</li>
<li><strong>图示 (参考图 14-3)：</strong> 边 <code>e12</code> 连接了 KF2 中的地图点 <code>P3D2c</code> (通过 <code>optimizer.vertex(id2)</code>) 和 Sim(3) 位姿 <code>g2oS12</code> (通过 <code>optimizer.vertex(0)</code>), 其测量值 (measurement) 是 KF1 中的观测 <code>obs1</code>。</li>
</ul>
</li>
<li><strong>反向投影边 (Inverse Projection Edge):</strong>
<ul>
<li><strong>描述：</strong> 将<strong>当前关键帧 KF1</strong> 中的一个地图点（在其自身的相机坐标系下），通过待优化的 Sim(3) 位姿的<strong>逆变换</strong> (<code>g2oS12</code>的逆，即<code>g2oS21</code>)，变换到<strong>闭环候选关键帧 KF2</strong> 的相机坐标系下，并进一步投影到 KF2 的图像平面上。其误差是该投影点与 KF2 中对应特征点的实际观测位置之间的差异。</li>
<li><strong>g2o 类型：</strong> <code>g2o::EdgeInverseSim3ProjectXYZ</code>。</li>
</ul>
</li>
</ol>
<h2 id="四-误差的定义-以正向投影边-g2oedgesim3projectxyz-为例"><a class="markdownIt-Anchor" href="#四-误差的定义-以正向投影边-g2oedgesim3projectxyz-为例"></a> 四、误差的定义 (以正向投影边 <code>g2o::EdgeSim3ProjectXYZ</code> 为例)</h2>
<p>边的核心是其误差函数，优化器会尝试最小化所有边误差的平方和。对于 Sim(3) 投影边，误差通常是<strong>重投影误差</strong>。其计算步骤如下：</p>
<ol>
<li><strong>获取三维点坐标：</strong><br />
从地图点顶点中获取其在<strong>源关键帧（例如 KF2）的相机坐标系</strong>下的三维坐标 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">P</mi><mtext>c2</mtext></msub></mrow><annotation encoding="application/x-tex">\mathbf{P}_{\text{c2}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83611em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">P</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">c2</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。在代码中如 <code>v2-&gt;estimate()</code>。</li>
<li><strong>通过 Sim(3) 位姿进行变换：</strong><br />
使用当前估计的 Sim(3) 位姿 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mn>12</mn></msub></mrow><annotation encoding="application/x-tex">S_{12}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> (从 KF2 到 KF1 的变换，代码中如 <code>v1-&gt;estimate()</code>)，将三维点 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">P</mi><mtext>c2</mtext></mrow><annotation encoding="application/x-tex">\mathbf{P}{\text{c2}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">P</span></span><span class="mord"><span class="mord text"><span class="mord">c2</span></span></span></span></span></span> <em>从 KF2 的相机坐标系变换到 KF1 的相机坐标系下，得到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">P</mi><mtext>c1</mtext></mrow><annotation encoding="application/x-tex">\mathbf{P}{\text{c1}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">P</span></span><span class="mord"><span class="mord text"><span class="mord">c1</span></span></span></span></span></span></em>。<br />
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">P</mi><mtext>c1</mtext><mo>=</mo><mi>S</mi><mn>12</mn><mo>⋅</mo><mi mathvariant="bold">P</mi><mtext>c2</mtext><mo>=</mo><mi>s</mi><mo>⋅</mo><mo stretchy="false">(</mo><mi>R</mi><mo>⋅</mo><mi mathvariant="bold">P</mi><mtext>c2</mtext><mo>+</mo><mi mathvariant="bold">t</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{P}{\text{c1}} = S{12} \cdot \mathbf{P}{\text{c2}} = s \cdot (R \cdot \mathbf{P}{\text{c2}} + \mathbf{t})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">P</span></span><span class="mord"><span class="mord text"><span class="mord">c1</span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord"><span class="mord">1</span><span class="mord">2</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">P</span></span><span class="mord"><span class="mord text"><span class="mord">c2</span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.44445em;vertical-align:0em;"></span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.76944em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord mathbf">P</span></span><span class="mord"><span class="mord text"><span class="mord">c2</span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathbf">t</span></span><span class="mclose">)</span></span></span></span><br />
这对应代码中的 <code>v1-&gt;estimate().map(v2-&gt;estimate())</code>。
<ul>
<li><code>map</code> 函数内部实现: <code>return s * (r * xyz) + t;</code></li>
</ul>
</li>
<li><strong>投影到归一化图像平面：</strong><br />
将变换到 KF1 相机坐标系下的三维点 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">P</mi><mtext>c1</mtext></msub><mo>=</mo><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo separator="true">,</mo><mi>Z</mi><msup><mo stretchy="false">)</mo><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{P}_{\text{c1}} = (X, Y, Z)^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83611em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">P</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">c1</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.0913309999999998em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span> 投影到其归一化图像平面（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">z=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>平面），得到二维坐标 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msup><mi>u</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo separator="true">,</mo><msup><mi>v</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><msup><mo stretchy="false">)</mo><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">(u&#x27;, v&#x27;)^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0913309999999998em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span>。<br />
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>u</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mi>X</mi><mi mathvariant="normal">/</mi><mi>Z</mi></mrow><annotation encoding="application/x-tex">u&#x27; = X / Z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span><br />
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>v</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mi>Y</mi><mi mathvariant="normal">/</mi><mi>Z</mi></mrow><annotation encoding="application/x-tex">v&#x27; = Y / Z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span><br />
这对应代码中的 <code>project(transformed_point)</code> 函数。
<ul>
<li><code>project</code> 函数内部实现: <code>res(0) = v(0)/v(2); res(1) = v(1)/v(2);</code></li>
</ul>
</li>
<li><strong>转换为像素坐标：</strong><br />
使用目标关键帧 KF1 的相机内参数（焦距 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mrow><mi>x</mi><mn>1</mn></mrow></msub><mo separator="true">,</mo><msub><mi>f</mi><mrow><mi>y</mi><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">f_{x1}, f_{y1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 和主点 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mrow><mi>x</mi><mn>1</mn></mrow></msub><mo separator="true">,</mo><msub><mi>c</mi><mrow><mi>y</mi><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">c_{x1}, c_{y1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>），将归一化平面坐标 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msup><mi>u</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo separator="true">,</mo><msup><mi>v</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><msup><mo stretchy="false">)</mo><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">(u&#x27;, v&#x27;)^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0913309999999998em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span> 转换为像素坐标 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>u</mi><mi>p</mi></msub><mo separator="true">,</mo><msub><mi>v</mi><mi>p</mi></msub><msup><mo stretchy="false">)</mo><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">(u_p, v_p)^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1274389999999999em;vertical-align:-0.286108em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span>。<br />
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>u</mi><mi>p</mi></msub><mo>=</mo><msub><mi>f</mi><mrow><mi>x</mi><mn>1</mn></mrow></msub><mo>⋅</mo><msup><mi>u</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>+</mo><msub><mi>c</mi><mrow><mi>x</mi><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">u_p = f_{x1} \cdot u&#x27; + c_{x1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.835222em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><br />
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>p</mi></msub><mo>=</mo><msub><mi>f</mi><mrow><mi>y</mi><mn>1</mn></mrow></msub><mo>⋅</mo><msup><mi>v</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>+</mo><msub><mi>c</mi><mrow><mi>y</mi><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">v_p = f_{y1} \cdot v&#x27; + c_{y1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.835222em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span><br />
这对应代码中的 <code>cam_map1(projected_point)</code> 函数。
<ul>
<li><code>cam_map1</code> 函数内部实现: <code>res[0] = v[0]*_focal_length1[0] + _principle_point1[0]; res[1] = v[1]*_focal_length1[1] + _principle_point1[1];</code></li>
</ul>
</li>
<li><strong>计算误差向量：</strong><br />
误差 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">e</mi></mrow><annotation encoding="application/x-tex">\mathbf{e}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.44444em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">e</span></span></span></span></span> 是<strong>实际观测到的像素坐标</strong> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">z</mi><mtext>obs</mtext><mo>=</mo><mo stretchy="false">(</mo><mi>u</mi><mtext>obs</mtext><mo separator="true">,</mo><msub><mi>v</mi><mtext>obs</mtext></msub><msup><mo stretchy="false">)</mo><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{z}{\text{obs}} = (u{\text{obs}}, v_{\text{obs}})^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">z</span></span><span class="mord"><span class="mord text"><span class="mord">obs</span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.0913309999999998em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord text"><span class="mord">obs</span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">obs</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span> （即 KF1 中匹配的特征点位置）与步骤 4 中<strong>投影得到的像素坐标</strong> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>u</mi><mi>p</mi></msub><mo separator="true">,</mo><msub><mi>v</mi><mi>p</mi></msub><msup><mo stretchy="false">)</mo><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">(u_p, v_p)^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1274389999999999em;vertical-align:-0.286108em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span> 之间的差值。<br />
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">e</mi><mo>=</mo><msub><mi mathvariant="bold">z</mi><mtext>obs</mtext></msub><mo>−</mo><mo stretchy="false">(</mo><msub><mi>u</mi><mi>p</mi></msub><mo separator="true">,</mo><msub><mi>v</mi><mi>p</mi></msub><msup><mo stretchy="false">)</mo><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{e} = \mathbf{z}_{\text{obs}} - (u_p, v_p)^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.44444em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">e</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.73333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">z</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">obs</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1274389999999999em;vertical-align:-0.286108em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><br />
这对应代码中的 <code>_error = obs - projected_pixel_coordinates;</code></li>
</ol>
<h2 id="五-sim3-位姿优化的流程-optimizeroptimizesim3-函数详解"><a class="markdownIt-Anchor" href="#五-sim3-位姿优化的流程-optimizeroptimizesim3-函数详解"></a> 五、Sim(3) 位姿优化的流程 (Optimizer::OptimizeSim3 函数详解)</h2>
<p>在 ORB-SLAM2 中，<code>Optimizer::OptimizeSim3</code> 函数负责执行此优化。其主要步骤如下：</p>
<ol>
<li><strong>步骤 1：初始化 g2o 优化器</strong>
<ul>
<li>创建一个 <code>g2o::SparseOptimizer</code> 对象。</li>
<li>配置求解器：通常选择 Levenberg-Marquardt (LM) 算法 (<code>g2o::OptimizationAlgorithmLevenberg</code>)。</li>
<li>配置线性求解器：例如 <code>g2o::LinearSolverDense</code> 或 <code>g2o::LinearSolverCholmod</code>，取决于问题的规模和稀疏性。</li>
</ul>
</li>
<li><strong>步骤 2：设置待优化的 Sim(3) 位姿作为顶点</strong>
<ul>
<li>创建一个 <code>g2o::VertexSim3Expmap</code> 类型的顶点 <code>vSim3</code>。</li>
<li>设置其初始估计值：使用传入的 <code>g2oS12</code>。</li>
<li>设置顶点 ID：通常设为 0 (<code>vSim3-&gt;setId(0)</code>)。</li>
<li><strong>设置顶点不固定：</strong> <code>vSim3-&gt;setFixed(false)</code>，因为这是我们要优化的变量。</li>
<li><strong>处理尺度固定性：</strong>
<ul>
<li><code>vSim3-&gt;_fix_scale = bFixScale;</code></li>
<li>如果传感器是<strong>单目相机 (Monocular)</strong>，<code>bFixScale</code> 通常为 <code>false</code>，尺度参数会参与优化。</li>
<li>如果传感器是<strong>双目相机 (Stereo)</strong> 或 <strong>RGB-D 相机</strong>，<code>bFixScale</code> 通常为 <code>true</code>，尺度参数固定为 1（或由双目/RGB-D直接提供），不参与优化。</li>
</ul>
</li>
<li>存储相关的相机内参（主点 <code>_principle_point1</code>, <code>_principle_point2</code> 和焦距 <code>_focal_length1</code>, <code>_focal_length2</code>）到 <code>vSim3</code> 顶点中，供边的误差函数计算使用。这些内参是从 KF1 和 KF2 的相机参数中获取的。</li>
<li>将此 Sim(3) 顶点添加到优化器中 (<code>optimizer.addVertex(vSim3)</code>)。</li>
</ul>
</li>
<li><strong>步骤 3：设置匹配的地图点作为顶点 (固定)</strong>
<ul>
<li>获取 KF1 和 KF2 之间匹配的地图点列表 (<code>vpMatches1</code>)。</li>
<li>遍历每一对匹配的地图点 (pMP1 来自 KF1, pMP2 来自 KF2)。</li>
<li><strong>检查有效性：</strong> 确保 pMP1 和 pMP2 都不是坏点 (<code>!pMP1-&gt;isBad() &amp;&amp; !pMP2-&gt;isBad()</code>)，并且 pMP2 在 KF2 中有对应的二维特征点索引 (<code>i2 &gt;= 0</code>)。</li>
<li>如果有效：
<ul>
<li><strong>为 pMP1 创建顶点 (KF1 相关):</strong>
<ul>
<li>创建一个 <code>g2o::VertexSBAPointXYZ</code> 顶点 <code>vPoint1</code>。</li>
<li>获取 pMP1 的世界坐标 <code>P3D1w</code>，然后使用 KF1 的位姿 (R1w, t1w) 将其转换到 KF1 的相机坐标系下 <code>P3D1c = R1w * P3D1w + t1w</code>。</li>
<li>设置 <code>vPoint1</code> 的估计值为 <code>P3D1c</code>。</li>
<li>设置顶点 ID (例如 <code>2*i + 1</code>，以避免与 Sim(3) 顶点和其他点顶点冲突)。</li>
<li><strong>设置顶点固定：</strong> <code>vPoint1-&gt;setFixed(true)</code>。</li>
<li>将 <code>vPoint1</code> 添加到优化器。</li>
</ul>
</li>
<li><strong>为 pMP2 创建顶点 (KF2 相关):</strong>
<ul>
<li>创建一个 <code>g2o::VertexSBAPointXYZ</code> 顶点 <code>vPoint2</code>。</li>
<li>获取 pMP2 的世界坐标 <code>P3D2w</code>，然后使用 KF2 的位姿 (R2w, t2w) 将其转换到 KF2 的相机坐标系下 <code>P3D2c = R2w * P3D2w + t2w</code>。</li>
<li>设置 <code>vPoint2</code> 的估计值为 <code>P3D2c</code>。</li>
<li>设置顶点 ID (例如 <code>2*(i+1)</code>).</li>
<li><strong>设置顶点固定：</strong> <code>vPoint2-&gt;setFixed(true)</code>。</li>
<li>将 <code>vPoint2</code> 添加到优化器。</li>
</ul>
</li>
</ul>
</li>
<li>对有效匹配进行计数 (<code>nCorrespondences++</code>)。</li>
</ul>
</li>
<li><strong>步骤 4：设置地图点投影关系作为边</strong><br />
对于每一组通过了步骤 3 检查的有效匹配 (pMP1, pMP2, 以及 KF1 中的观测 kpUn1 和 KF2 中的观测 kpUn2)：
<ul>
<li><strong>4.1 添加正向投影边 (KF2 -&gt; KF1):</strong>
<ul>
<li>创建一个 <code>g2o::EdgeSim3ProjectXYZ</code> 类型的边 <code>e12</code>。</li>
<li>设置连接的顶点：
<ul>
<li>第一个顶点 (index 0 in edge) 是 KF2 的地图点顶点 <code>vPoint2</code> (代码中用 <code>optimizer.vertex(id2)</code>)。</li>
<li>第二个顶点 (index 1 in edge) 是 Sim(3) 位姿顶点 <code>vSim3</code> (代码中用 <code>optimizer.vertex(0)</code>)。</li>
</ul>
</li>
<li>设置测量值 (Measurement)：使用 KF1 中对应的未畸变特征点的像素坐标 <code>obs1 = (kpUn1.pt.x, kpUn1.pt.y)</code>。</li>
<li>设置信息矩阵 (Information Matrix)：通常是一个对角矩阵，其对角元素与特征点观测的确定性有关，一般取图像金字塔层级的逆方差 (<code>invSigmaSquare1 = pKF1-&gt;mvInvLevelSigma2[kpUn1.octave]</code>)。信息矩阵是协方差矩阵的逆，表示测量值的可信度。<br />
<code>e12-&gt;setInformation(Eigen::Matrix2d::Identity() * invSigmaSquare1);</code></li>
<li>设置鲁棒核函数 (Robust Kernel)：例如 Huber 核 (<code>g2o::RobustKernelHuber</code>)，以减小离群点 (outliers) 对优化结果的负面影响。设置核函数的宽度 (<code>deltaHuber</code>)。</li>
<li>将边 <code>e12</code> 添加到优化器，并存入列表 <code>vpEdges12</code>。</li>
</ul>
</li>
<li><strong>4.2 添加反向投影边 (KF1 -&gt; KF2):</strong>
<ul>
<li>创建一个 <code>g2o::EdgeInverseSim3ProjectXYZ</code> 类型的边 <code>e21</code>。</li>
<li>设置连接的顶点：
<ul>
<li>第一个顶点是 KF1 的地图点顶点 <code>vPoint1</code>。</li>
<li>第二个顶点是 Sim(3) 位姿顶点 <code>vSim3</code>。</li>
</ul>
</li>
<li>设置测量值：使用 KF2 中对应的未畸变特征点的像素坐标 <code>obs2</code>。</li>
<li>设置信息矩阵（基于 KF2 中特征点的金字塔层级）。</li>
<li>设置鲁棒核函数。</li>
<li>将边 <code>e21</code> 添加到优化器，并存入列表 <code>vpEdges21</code>。</li>
</ul>
</li>
<li>记录边的索引，用于后续的 outlier 剔除。</li>
</ul>
</li>
<li><strong>步骤 5：第一次 g2o 优化</strong>
<ul>
<li>初始化优化 (<code>optimizer.initializeOptimization()</code>)。</li>
<li>执行固定次数的迭代优化，例如 5 次 (<code>optimizer.optimize(5)</code>)。</li>
</ul>
</li>
<li><strong>步骤 6：用卡方检验剔除误差大的边 (Outlier Rejection)</strong>
<ul>
<li>遍历步骤 4 中添加的所有边对 (<code>vpEdges12[i]</code> 和 <code>vpEdges21[i]</code>)。</li>
<li>对于每条边，计算其卡方误差 (<code>e12-&gt;chi2()</code> 和 <code>e21-&gt;chi2()</code>)。卡方值是误差项经过信息矩阵加权后的平方和，表示这条边对当前模型拟合的好坏程度。</li>
<li>如果正向投影边或反向投影边的卡方误差<strong>任何一个</strong>超过预设的阈值 <code>th2</code>：
<ul>
<li>认为这对匹配是外点 (outlier)。</li>
<li>从优化器中移除这两条边 (<code>optimizer.removeEdge(e12)</code>, <code>optimizer.removeEdge(e21)</code>).</li>
<li>将对应的原始匹配关系 <code>vpMatches1[idx]</code> 标记为无效 (例如设为 <code>NULL</code>)。</li>
<li>将 <code>vpEdges12[i]</code> 和 <code>vpEdges21[i]</code> 在列表中的对应位置也标记为无效。</li>
<li>累加坏点（被剔除的匹配对）的数量 <code>nBad++</code>。</li>
</ul>
</li>
</ul>
</li>
<li><strong>步骤 7：第二次 g2o 优化 (根据情况调整迭代次数)</strong>
<ul>
<li>根据 <code>nBad</code> 的数量决定迭代次数：
<ul>
<li>如果 <code>nBad &gt; 0</code> (即有边被剔除)，说明初始的匹配中存在较多外点，闭环质量可能不是非常好，此时进行更多次迭代，例如 10 次 (<code>nMoreIterations = 10</code>)。</li>
<li>如果 <code>nBad == 0</code> (没有边被剔除)，说明初始匹配质量较高，进行较少次数迭代，例如 5 次 (<code>nMoreIterations = 5</code>)。</li>
</ul>
</li>
<li><strong>检查剩余有效匹配数量：</strong> 如果经过外点剔除后，剩余的有效匹配数量 (<code>nCorrespondences - nBad</code>) 过少（例如小于 10），则认为闭环质量太差，放弃本次优化，直接返回 0 (表示没有足够的内点支持)。</li>
<li>在剔除了外点之后，再次执行 g2o 优化 (<code>optimizer.optimize(nMoreIterations)</code>)。</li>
</ul>
</li>
<li><strong>步骤 8：用优化后的结果更新 Sim(3) 位姿</strong>
<ul>
<li>从优化器中获取优化后的 Sim(3) 顶点：<br />
<code>g2o::VertexSim3Expmap* vSim3_recov = static_cast&lt;g2o::VertexSim3Expmap*&gt;(optimizer.vertex(0));</code></li>
<li>用该顶点的最新估计值更新输入的 <code>g2oS12</code> 参数：<br />
<code>g2oS12 = vSim3_recov-&gt;estimate();</code></li>
<li>返回内点的数量 (<code>nCorrespondences - nBad</code>)，这个数量可以作为 Sim(3) 优化成功与否以及闭环质量的一个指标。</li>
</ul>
</li>
</ol>
<h2 id="六-总结图-14-3-sim3-位姿优化中的顶点和边"><a class="markdownIt-Anchor" href="#六-总结图-14-3-sim3-位姿优化中的顶点和边"></a> 六、总结图 14-3 (Sim(3) 位姿优化中的顶点和边)</h2>
<ul>
<li><strong>当前关键帧 KF1:</strong> 我们试图将闭环候选帧对齐到的参考帧。</li>
<li><strong>闭环候选关键帧 KF2:</strong> 检测到的可能与 KF1 形成闭环的帧。</li>
<li><strong><code>g2oS12</code> (指向 <code>optimizer.vertex(0)</code>):</strong> 核心待优化的 Sim(3) 变换。它描述了如何将 KF2 的坐标系（及其关联的地图点）变换到 KF1 的坐标系。</li>
<li><strong><code>P3D2c</code> (指向 <code>optimizer.vertex(id2)</code>):</strong> 一个在 KF2 的相机坐标系下表示的三维地图点。这个点在优化过程中其坐标是<strong>固定不变</strong>的。</li>
<li><strong><code>obs1</code>:</strong> 地图点 <code>P3D2c</code> 在 KF1 图像上的实际观测到的二维像素坐标。这是边的测量值。</li>
<li><strong><code>e12</code> (类型为 <code>g2o::EdgeSim3ProjectXYZ()</code>):</strong> 一条正向投影边。它约束了 <code>g2oS12</code>。该边的误差计算过程是：将 <code>P3D2c</code> 通过当前的 <code>g2oS12</code> 估计值从 KF2 坐标系变换到 KF1 坐标系，再投影到 KF1 的图像平面，然后与 <code>obs1</code> 比较得出重投影误差。</li>
</ul>
<h2 id="七-简要总结"><a class="markdownIt-Anchor" href="#七-简要总结"></a> 七、简要总结</h2>
<p>闭环线程中的 Sim(3) 位姿优化是一个至关重要的步骤，它旨在精确估计当前关键帧与过去某个关键帧之间的相对位姿（包括尺度）。通过构建一个包含 Sim(3) 位姿和固定地图点的图模型，并利用它们之间的重投影约束，使用如图优化（g2o）的迭代方法来最小化重投影误差。这个过程还包括鲁棒的外点剔除机制，以确保优化结果的准确性和稳定性，为后续的闭环融合和全局姿态图优化奠定基础。</p>
</article><div class="tag_share"><div class="post-share"><div class="social-share" data-image="https://fyblog.oss-cn-shanghai.aliyuncs.com/blog/20250428231608640.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/05/14/orbslam2-13/" title="优化——局部地图优化"><img class="cover" src="https://fyblog.oss-cn-shanghai.aliyuncs.com/blog/20250428231608640.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">优化——局部地图优化</div></div><div class="info-2"><div class="info-item-1"> 局部建图线程中局部地图优化 (Local Bundle Adjustment in Local Mapping Thread)  引言 在 ORB-SLAM2 系统中，局部建图线程负责处理新的关键帧，并优化局部的地图。LocalBundleAdjustment (局部BA) 是该线程中的核心函数，主要用于优化当前关键帧及其邻近区域的关键帧位姿和它们观测到的地图点三维位置，以构建一个局部一致的地图。  核心思想 全局的 Bundle Adjustment (BA) 会优化所有的关键帧和地图点，计算成本非常高。局部BA的思想是只对当前活跃的、与当前关键帧紧密相关的一个子图进行优化。这大幅降低了计算复杂度，使得系统能够实时运行，同时通过不断优化局部区域，逐步累积实现全局地图的一致性。   关键概念 (参考图 14-2) 理解局部BA，首先要明确参与优化的不同元素：  当前关键帧 (Current KF):  定义：最新插入到地图的关键帧，是本次局部BA的触发者和中心。 图14-2标识：中间的红色相机图标 (“当前KF”)。   局部关键帧 (LocalKeyFrames /...</div></div></div></a><a class="pagination-related" href="/2025/05/14/orbslam2-15/" title="优化——闭环时本质图优化"><img class="cover" src="https://fyblog.oss-cn-shanghai.aliyuncs.com/blog/20250428231608640.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">优化——闭环时本质图优化</div></div><div class="info-2"><div class="info-item-1">本章节主要阐述在ORB-SLAM2系统中，当检测到闭环（Loop Closing）后，如何通过优化一个称为“本质图”（Essential Graph）的结构来全局校正和优化所有关键帧的位姿。这个过程对消除累积误差、提升地图全局一致性和定位精度至关重要。  一、优化的核心目标与对象  核心函数：OptimizeEssentialGraph。 主要目标：在闭环确认后，对系统中所有已记录的关键帧的位姿（包括位置和姿态，即Sim(3)变换）进行一次全局性的优化调整。 关键点：  不直接优化地图点：在这一特定步骤中，优化过程的变量是关键帧的位姿，而不是三维地图点的坐标。地图点的位置会在关键帧位姿优化完毕后，根据其参考关键帧的位姿更新进行调整。 全局性：优化会影响到地图中所有的关键帧，以达到全局最优的目的。     二、本质图的构成：顶点...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://fyblog.oss-cn-shanghai.aliyuncs.com/blog/20250423093410435.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Xue</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">32</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%97%AD%E7%8E%AF%E7%BA%BF%E7%A8%8B%E4%B8%AD%E7%9A%84-sim3-%E4%BD%8D%E5%A7%BF%E4%BC%98%E5%8C%96"><span class="toc-text"> 闭环线程中的 Sim(3) 位姿优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E6%A0%B8%E5%BF%83%E6%80%9D%E6%83%B3%E5%9B%BE%E4%BC%98%E5%8C%96-graph-optimization"><span class="toc-text"> 一、核心思想：图优化 (Graph Optimization)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E9%A1%B6%E7%82%B9%E7%9A%84%E9%80%89%E6%8B%A9-vertices"><span class="toc-text"> 二、顶点的选择 (Vertices)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E8%BE%B9%E7%9A%84%E9%80%89%E6%8B%A9-edges"><span class="toc-text"> 三、边的选择 (Edges)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-%E8%AF%AF%E5%B7%AE%E7%9A%84%E5%AE%9A%E4%B9%89-%E4%BB%A5%E6%AD%A3%E5%90%91%E6%8A%95%E5%BD%B1%E8%BE%B9-g2oedgesim3projectxyz-%E4%B8%BA%E4%BE%8B"><span class="toc-text"> 四、误差的定义 (以正向投影边 g2o::EdgeSim3ProjectXYZ 为例)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-sim3-%E4%BD%8D%E5%A7%BF%E4%BC%98%E5%8C%96%E7%9A%84%E6%B5%81%E7%A8%8B-optimizeroptimizesim3-%E5%87%BD%E6%95%B0%E8%AF%A6%E8%A7%A3"><span class="toc-text"> 五、Sim(3) 位姿优化的流程 (Optimizer::OptimizeSim3 函数详解)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD-%E6%80%BB%E7%BB%93%E5%9B%BE-14-3-sim3-%E4%BD%8D%E5%A7%BF%E4%BC%98%E5%8C%96%E4%B8%AD%E7%9A%84%E9%A1%B6%E7%82%B9%E5%92%8C%E8%BE%B9"><span class="toc-text"> 六、总结图 14-3 (Sim(3) 位姿优化中的顶点和边)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83-%E7%AE%80%E8%A6%81%E6%80%BB%E7%BB%93"><span class="toc-text"> 七、简要总结</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background: transparent;"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By Xue</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(async () => {
  const showKatex = () => {
    document.querySelectorAll('#article-container .katex').forEach(el => el.classList.add('katex-show'))
  }

  if (!window.katex_js_css) {
    window.katex_js_css = true
    await btf.getCSS('https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css')
    if (false) {
      await btf.getScript('https://cdn.jsdelivr.net/npm/katex/dist/contrib/copy-tex.min.js')
    }
  }

  showKatex()
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>